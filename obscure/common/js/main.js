function processImage(){console.log("processing...");var t=Date.now(),n=getPointsFromImage(),e=Date.now();console.log("point count:",n.length),console.log("image processing took:",e-t),generatePathFromPoints(n);var i=Date.now();console.log("path finding took:",i-e),osCtx.clearRect(0,0,settings.width,settings.height)}function getPointsFromImage(){var t=settings.threshold,n=settings.sampleScale,e=n*(settings.width/viewWidth),i=1/e,o=settings.maxWeight,r=osCanvas.height*n|0;osCtx.drawImage(image,0,0,r,r);for(var s=this.osCtx.getImageData(0,0,r,r),a=s.data,l=[],h=0;h<a.length;h+=4){var c=a[h],u=a[h+1],g=a[h+2],f=(c+u+g)/3|0,d=h/4%r*i,m=(h/4/r|0)*i;if(f>t){var v={x:d+randomRange(-.1,.1),y:m+randomRange(-.1,.1),weight:0|map(f,t,255,1,o)};l.push(v)}}return l}function generatePathFromPoints(t){for(var n,e=Math.random,i=function(t,n){var i=(t.x-n.x)*(e()-.5),o=(t.y-n.y)*(e()-.5);return i*i+o*o},o=["x","y"],r=new kdTree(t,i,o),s=new kdTree(t,i,o),a=[],l=t[0],h=t.length;h;)n=r.nearest(l,1)[0][0],l=n,r.remove(l),a.push(l),h--;outputPath=a,outputTree=s}function update(){this.updateDrawing(),this.drawToCanvas(),requestAnimationFrame(update)}function updateDrawing(){var t=outputPath[currentFrame],n=0,e=settings.frameStep;osCtx.strokeStyle="#333",osCtx.lineWidth=settings.lineWidth;for(var i;++n<=e&&t;)osCtx.beginPath(),osCtx.moveTo(t.x,t.y),i=outputTree.nearest(t,t.weight),i.forEach(function(t){osCtx.lineTo(t[0].x,t[0].y)}),osCtx.stroke(),t=outputPath[++this.currentFrame]}function drawToCanvas(){ctx.clearRect(0,0,viewWidth,viewHeight),ctx.drawImage(osCanvas,0,0,viewWidth,viewHeight)}function randomRange(t,n){return t+Math.random()*(n-t)}function map(t,n,e,i,o){return(t-n)/(e-n)*(o-i)+i}!function(t,n){"function"==typeof define&&define.amd?define(["exports"],n):n("object"==typeof exports?exports:t.commonJsStrict={})}(this,function(t){function n(t,n,e){this.obj=t,this.left=null,this.right=null,this.parent=e,this.dimension=n}function e(t,e,o){function r(t,e,i){var s,a,l=e%o.length;return 0===t.length?null:1===t.length?new n(t[0],l,i):(t.sort(function(t,n){return t[o[l]]-n[o[l]]}),s=Math.floor(t.length/2),a=new n(t[s],l,i),a.left=r(t.slice(0,s),e+1,a),a.right=r(t.slice(s+1),e+1,a),a)}function s(t){function n(t){t.left&&(t.left.parent=t,n(t.left)),t.right&&(t.right.parent=t,n(t.right))}a.root=t,n(a.root)}var a=this;Array.isArray(t)?this.root=r(t,0,null):s(t,e,o),this.toJSON=function(t){t||(t=this.root);var e=new n(t.obj,t.dimension,null);return t.left&&(e.left=a.toJSON(t.left)),t.right&&(e.right=a.toJSON(t.right)),e},this.insert=function(t){function e(n,i){if(null===n)return i;var r=o[n.dimension];return t[r]<n.obj[r]?e(n.left,n):e(n.right,n)}var i,r,s=e(this.root,null);return null===s?void(this.root=new n(t,0,null)):(i=new n(t,(s.dimension+1)%o.length,s),r=o[s.dimension],void(t[r]<s.obj[r]?s.left=i:s.right=i))},this.remove=function(t){function n(e){if(null===e)return null;if(e.obj===t)return e;var i=o[e.dimension];return t[i]<e.obj[i]?n(e.left,e):n(e.right,e)}function e(t){function n(t,e){var i,r,s,a,l;return null===t?null:(i=o[e],t.dimension===e?null!==t.left?n(t.left,e):t:(r=t.obj[i],s=n(t.left,e),a=n(t.right,e),l=t,null!==s&&s.obj[i]<r&&(l=s),null!==a&&a.obj[i]<l.obj[i]&&(l=a),l))}var i,r,s;return null===t.left&&null===t.right?null===t.parent?void(a.root=null):(s=o[t.parent.dimension],void(t.obj[s]<t.parent.obj[s]?t.parent.left=null:t.parent.right=null)):void(null!==t.right?(i=n(t.right,t.dimension),r=i.obj,e(i),t.obj=r):(i=n(t.left,t.dimension),r=i.obj,e(i),t.right=t.left,t.left=null,t.obj=r))}var i;i=n(a.root),null!==i&&e(i)},this.nearest=function(t,n,r){function s(i){function r(t,e){c.push([t,e]),c.size()>n&&c.pop()}var a,l,h,u,g=o[i.dimension],f=e(t,i.obj),d={};for(u=0;u<o.length;u+=1)u===i.dimension?d[o[u]]=t[o[u]]:d[o[u]]=i.obj[o[u]];return l=e(d,i.obj),null===i.right&&null===i.left?void((c.size()<n||f<c.peek()[1])&&r(i,f)):(a=null===i.right?i.left:null===i.left?i.right:t[g]<i.obj[g]?i.left:i.right,s(a),(c.size()<n||f<c.peek()[1])&&r(i,f),void((c.size()<n||Math.abs(l)<c.peek()[1])&&(h=a===i.left?i.right:i.left,null!==h&&s(h))))}var l,h,c;if(c=new i(function(t){return-t[1]}),r)for(l=0;n>l;l+=1)c.push([null,r]);for(a.root&&s(a.root),h=[],l=0;l<Math.min(n,c.content.length);l+=1)c.content[l][0]&&h.push([c.content[l][0].obj,c.content[l][1]]);return h},this.balanceFactor=function(){function t(n){return null===n?0:Math.max(t(n.left),t(n.right))+1}function n(t){return null===t?0:n(t.left)+n(t.right)+1}return t(a.root)/(Math.log(n(a.root))/Math.log(2))}}function i(t){this.content=[],this.scoreFunction=t}i.prototype={push:function(t){this.content.push(t),this.bubbleUp(this.content.length-1)},pop:function(){var t=this.content[0],n=this.content.pop();return this.content.length>0&&(this.content[0]=n,this.sinkDown(0)),t},peek:function(){return this.content[0]},remove:function(t){for(var n=this.content.length,e=0;n>e;e++)if(this.content[e]==t){var i=this.content.pop();return void(e!=n-1&&(this.content[e]=i,this.scoreFunction(i)<this.scoreFunction(t)?this.bubbleUp(e):this.sinkDown(e)))}throw new Error("Node not found.")},size:function(){return this.content.length},bubbleUp:function(t){for(var n=this.content[t];t>0;){var e=Math.floor((t+1)/2)-1,i=this.content[e];if(!(this.scoreFunction(n)<this.scoreFunction(i)))break;this.content[e]=n,this.content[t]=i,t=e}},sinkDown:function(t){for(var n=this.content.length,e=this.content[t],i=this.scoreFunction(e);;){var o=2*(t+1),r=o-1,s=null;if(n>r){var a=this.content[r],l=this.scoreFunction(a);i>l&&(s=r)}if(n>o){var h=this.content[o],c=this.scoreFunction(h);(null==s?i:l)>c&&(s=o)}if(null==s)break;this.content[t]=this.content[s],this.content[s]=e,t=s}}},this.kdTree=e,t.kdTree=e,t.BinaryHeap=i});var viewWidth=0,viewHeight=0,canvas=document.getElementById("obs-ca"),ctx=canvas.getContext("2d"),osCanvas=document.createElement("canvas"),osCtx=osCanvas.getContext("2d"),settings={width:400,height:400,threshold:250,sampleScale:1,maxWeight:24,frameStep:4,lineWidth:.1},outputPath,outputTree,currentFrame=0,image=document.createElement("img");image.crossOrigin="Anonymous",image.src="/obscure/common/img/sketch.jpg",image.onload=function(){viewWidth=canvas.width=canvas.clientWidth,viewHeight=canvas.height=canvas.clientHeight,osCanvas.width=settings.width,osCanvas.height=settings.height,processImage(),osCanvas.width=viewWidth,osCanvas.height=viewHeight},$(function(){"use scrict";function t(){var t=$(window).height(),n=$(window).width();$("#main-visual").css({height:t});var e=t*t+n*n;e=Math.sqrt(e),$("#main-visual-bg").css({height:e})}function n(){var t=$("#obs-ca"),n=$("#wrap-canvas");t.attr({height:n.height()}),t.attr({width:n.width()})}t();var e="3596645554.1677ed0.1b1f5e4ba7854f10a972fc95d2a5e8cc",i=1;$.ajax({url:"https://api.instagram.com/v1/users/self/media/recent/?access_token="+e+"&callback=?",dataType:"jsonp",timeout:3e4}).then(function(t){$.each(t.data,function(t,n){return 30===t?!1:($('<li><a class="modal pic-'+i+'" href=""><img src="'+n.images.standard_resolution.url+'"></a></li>').appendTo("#js-instalib"),void i++)})},function(){console.log("データ取得失敗")});var o=new TimelineMax,r=$("#js-modal-layer");$(document).on("click","#js-instalib li a",function(){var t=$(this).find("img").attr("src");return $("#img-insta").addClass("block").css({top:$(document).scrollTop()+40}),o.to(r,0,{opacity:".7",onComplete:function(){r.addClass("block")}}),$("#img-insta").append("<img src="+t+' alt="">'),!1}),r.on("click",function(){o.to($("#img-insta").find("img"),.2,{opacity:"0",transform:"scale(.2)",onComplete:function(){$("#img-insta").find("img").remove(),$("#img-insta").removeClass("block")}}),o.to($(this),.3,{opacity:"0",onComplete:function(){r.removeClass("block")}})});var s=window.innerWidth;window.addEventListener("resize",function(){t(),s!=window.innerWidth&&(s=window.innerWidth,n())}),n();var a=!0;$("html,body").animate({scrollTop:0},0),$(window).scroll(function(){var t=$(".main").offset().top,n=$(document).scrollTop()+window.innerHeight/2;n>t&&a===!0&&($("#js-instalib li").addClass("item"),navigator.userAgent.indexOf("iPhone")>0||navigator.userAgent.indexOf("iPad")>0||navigator.userAgent.indexOf("iPod")>0||navigator.userAgent.indexOf("Android")>0?$("#main").addClass("sp"):requestAnimationFrame(update),a=!1)})});